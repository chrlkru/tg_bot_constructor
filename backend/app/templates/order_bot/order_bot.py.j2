{# --------------------------------------------------------------------
   Order-Bot (aiogram-3) ‚Äî —Ñ–∞–π–ª-—à–∞–±–ª–æ–Ω
   –ü–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ–¥—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:
       {{ project_id }}    ‚Äì —á–∏—Å–ª–æ–≤–æ–π ID –ø—Ä–æ–µ–∫—Ç–∞ (–∫–æ–ª–ª–µ–∫—Ü–∏—è –≤ –ë–î)
       {{ admin_chat_id }} ‚Äì id –≥—Ä—É–ø–ø—ã, –≥–¥–µ –¥–æ—Å—Ç—É–ø–Ω–∞ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
-------------------------------------------------------------------- #}
#!/usr/bin/env python3
# -*- coding: utf-8 -*-

from utils.media import save_media_file
import logging
import os
import tempfile
from pathlib import Path
from html import escape
from utils.collage import generate_collage
from dotenv import load_dotenv
from aiogram import Bot, Dispatcher, types
from aiogram.client.default import DefaultBotProperties
from aiogram.filters import Command, StateFilter
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.fsm.storage.memory import MemoryStorage
from aiogram.utils.keyboard import InlineKeyboardBuilder
from aiogram.types import (
    BotCommand, BotCommandScopeDefault, BotCommandScopeAllPrivateChats,
    BotCommandScopeAllGroupChats, BotCommandScopeChat, FSInputFile
)

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
load_dotenv()
BOT_TOKEN = os.getenv("TOKEN")
if not BOT_TOKEN:
    raise RuntimeError("–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è TOKEN –Ω–µ –∑–∞–¥–∞–Ω–∞")

PROJECT_ID = {{ project_id }}
ADMIN_CHAT = {{ admin_chat_id }}

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ø–æ–¥–∫–ª—é—á–∞–µ–º –ë–î-–º–æ–¥—É–ª—å ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# utils/order_dp.py –¥–æ–ª–∂–µ–Ω –ª–µ–∂–∞—Ç—å —Ä—è–¥–æ–º —Å utils/order_bot.db
from utils import order_db as db          # ‚Üê –Ω–æ–≤—ã–π import
db.init_db()
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
bot = Bot(token=BOT_TOKEN,
          default=DefaultBotProperties(parse_mode="HTML"))
dp  = Dispatcher(storage=MemoryStorage())

MEDIA_ROOT = Path(__file__).resolve().parent / "media" / str(PROJECT_ID)

# ‚îÄ‚îÄ‚îÄ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π FSM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
class CatalogState(StatesGroup):
    page = State()  # —Ç–µ–∫—É—â–µ–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –º–µ–Ω—é —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∫–∞—Ç–∞–ª–æ–≥–∞

class CartState(StatesGroup):
    checkout_address = State()   # –æ–∂–∏–¥–∞–Ω–∏–µ –≤–≤–æ–¥–∞ –∞–¥—Ä–µ—Å–∞
    checkout_media   = State()   # –æ–∂–∏–¥–∞–Ω–∏–µ –º–µ–¥–∏–∞-—Ñ–∞–π–ª–∞ –∏–ª–∏ –æ—Ç–∫–∞–∑–∞
    checkout_confirm = State()   # –æ–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞

class ProductAdminState(StatesGroup):
    name        = State()  # –≤–≤–æ–¥ –Ω–∞–∑–≤–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞
    short_desc  = State()  # –≤–≤–æ–¥ –∫—Ä–∞—Ç–∫–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è
    full_desc   = State()  # –≤–≤–æ–¥ –ø–æ–ª–Ω–æ–≥–æ –æ–ø–∏—Å–∞–Ω–∏—è
    waiting_img = State()  # –æ–∂–∏–¥–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞

class DeleteProductState(StatesGroup):
    selecting_page    = State()  # –≤—ã–±–æ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∫–∞—Ç–∞–ª–æ–≥–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
    confirming_delete = State()  # –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞

# ‚îÄ‚îÄ‚îÄ –ö–æ–º–∞–Ω–¥—ã /debug –∏ /chatid (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

@dp.message(Command("chatid"))
async def cmd_chatid(msg: types.Message):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç ID —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞ (–¥–ª—è –ø–æ–º–æ—â–∏ –≤ –ø–æ–ª—É—á–µ–Ω–∏–∏ ADMIN_CHAT_ID)."""
    await msg.answer(f"–≠—Ç–æ—Ç —á–∞—Ç –∏–º–µ–µ—Ç ID: `{msg.chat.id}`", parse_mode="Markdown")

# ‚îÄ‚îÄ‚îÄ –ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
@dp.message(Command("start", "catalog"))
async def cmd_catalog(message: types.Message, state: FSMContext):

    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É /start –∏–ª–∏ /catalog ‚Äì –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫–∞—Ç–∞–ª–æ–≥–∞."""
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    if db.is_banned(PROJECT_ID, message.from_user.id):
        return await message.answer("‚ùå –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã.")
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∫–∞—Ç–∞–ª–æ–≥–∞ –Ω–∞ 1 –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
    await state.update_data(page=1)
    await send_catalog_page(message.chat.id, state)

@dp.callback_query(lambda c: c.data in {"prev", "next"}, StateFilter(CatalogState.page))
async def catalog_nav(cb: types.CallbackQuery, state: FSMContext):
    """–õ–∏—Å—Ç–∞–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∫–∞—Ç–∞–ª–æ–≥–∞ (–Ω–∞–∑–∞–¥/–≤–ø–µ—Ä–µ–¥) –ø–æ –Ω–∞–∂–∞—Ç–∏—è–º inline-–∫–Ω–æ–ø–æ–∫."""
    data = await state.get_data()
    page = data.get("page", 1)
    products = db.get_products_list(PROJECT_ID)

    # –ò–∑–º–µ–Ω—è–µ–º –Ω–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞–∂–∞—Ç–æ–π –∫–Ω–æ–ø–∫–∏
    if cb.data == "prev" and page > 1:
        page -= 1
    elif cb.data == "next" and page * 9 < len(products):
        page += 1

    await state.update_data(page=page)
    await send_catalog_page(cb.message.chat.id, state)
    await cb.answer()  # —É–±–∏—Ä–∞–µ–º "—á–∞—Å–∏–∫–∏" –Ω–∞ –∫–Ω–æ–ø–∫–µ

async def send_catalog_page(chat_id: int, state: FSMContext):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ-–∫–æ–ª–ª–∞–∂ —Å —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ–π –∫–∞—Ç–∞–ª–æ–≥–∞ –∏ –∫–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏."""
    page = (await state.get_data()).get("page", 1)
    products = db.get_products_list(PROJECT_ID)
    # –ü–æ–ª—É—á–∞–µ–º —Å—Ä–µ–∑ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –¥–∞–Ω–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–ø–æ 9 –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É)
    slice_ = products[(page - 1) * 9 : page * 9]

    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–ª–ª–∞–∂ –∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Ç–æ–≤–∞—Ä–æ–≤ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
    collage_path = Path(tempfile.gettempdir()) / f"catalog_{page}.jpg"
    generate_collage([str(MEDIA_ROOT / p["media"]) for p in slice_ if p["media"]], collage_path)

    # –°–æ–∑–¥–∞—ë–º inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É: –∫–Ω–æ–ø–∫–∏ —Å –Ω–æ–º–µ—Ä–∞–º–∏ —Ç–æ–≤–∞—Ä–æ–≤ –∏ —Å—Ç—Ä–µ–ª–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    kb = InlineKeyboardBuilder()
    for idx in range(1, len(slice_) + 1):
        kb.button(text=str(idx), callback_data=f"sel_{idx}")
    if page > 1:
        kb.button(text="‚óÄÔ∏è", callback_data="prev")
    if page * 9 < len(products):
        kb.button(text="‚ñ∂Ô∏è", callback_data="next")
    kb.adjust(3)  # —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ: –Ω–æ–º–µ—Ä–∞ —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ 3 –≤ —Ä—è–¥, –Ω–∞–≤–∏–≥–∞—Ü–∏—è –Ω–∞ –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–µ

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é-–∫–æ–ª–ª–∞–∂ —Å –ø–æ–¥–ø–∏—Å—å—é –∏ inline-–∫–Ω–æ–ø–∫–∞–º–∏
    await bot.send_photo(chat_id, FSInputFile(collage_path), caption=f"–°—Ç—Ä–∞–Ω–∏—Ü–∞ {page}", reply_markup=kb.as_markup())
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ FSM –∫–∞—Ç–∞–ª–æ–≥–∞ (–Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∫–∞—Ç–∞–ª–æ–≥–∞)
    await state.set_state(CatalogState.page)

@dp.callback_query(lambda c: c.data.startswith("sel_"), StateFilter(CatalogState.page))
async def on_select_product(cb: types.CallbackQuery, state: FSMContext):
    idx = int(cb.data.split("_")[1]) - 1
    page = (await state.get_data())["page"]
    products = db.get_products_list(PROJECT_ID)
    gidx = (page - 1) * 9 + idx
    if gidx >= len(products):
        return await cb.answer("–ù–µ–≤–µ—Ä–Ω—ã–π –≤—ã–±–æ—Ä", show_alert=True)

    product = products[gidx]
    caption = (
        f"<b>{escape(product['name'])}</b>\n\n"
        f"{escape(product['short_desc'])}\n\n"
        f"{escape(product['full_desc'])}"
    )
    chat_id = cb.message.chat.id          # ‚Üê –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–ª—É—á–∞—Ç–µ–ª—å

    if product["media"]:
        await bot.send_photo(chat_id, FSInputFile(MEDIA_ROOT / product["media"]), caption=caption)
    else:
        await bot.send_message(chat_id, caption)

    # –ò–Ω–ª–∞–π–Ω-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞
    kb = InlineKeyboardBuilder()
    if chat_id != ADMIN_CHAT:             # –≤ –∫–∞—Ç–∞–ª–æ–≥–µ –∞–¥–º–∏–Ω-–≥—Ä—É–ø–ø—ã –∫–æ—Ä–∑–∏–Ω–∞ –Ω–µ –Ω—É–∂–Ω–∞
        kb.button(text="‚ûï –í –∫–æ—Ä–∑–∏–Ω—É", callback_data=f"add_{product['id']}")
    kb.button(text="‚Üê –ù–∞–∑–∞–¥", callback_data="back")
    kb.adjust(1)
    await bot.send_message(chat_id, "–ß—Ç–æ –¥–∞–ª—å—à–µ?", reply_markup=kb.as_markup())
    await cb.answer()


@dp.callback_query(lambda c: c.data == "back", StateFilter(CatalogState.page))
async def back_to_catalog(cb: types.CallbackQuery, state: FSMContext):
    """–í–æ–∑–≤—Ä–∞—Ç –∫ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∫–∞—Ç–∞–ª–æ–≥–∞ (–ø–æ—Å–ª–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ç–æ–≤–∞—Ä–∞)."""
    await send_catalog_page(cb.message.chat.id, state)
    await cb.answer()

# ‚îÄ‚îÄ‚îÄ –ö–æ—Ä–∑–∏–Ω–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
@dp.callback_query(lambda c: c.data.startswith("add_"))
async def add_to_cart(cb: types.CallbackQuery):
    """–î–æ–±–∞–≤–ª—è–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–æ–≤–∞—Ä –≤ –∫–æ—Ä–∑–∏–Ω—É (–æ–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è '‚ûï –í –∫–æ—Ä–∑–∏–Ω—É')."""
    product_id = int(cb.data.split("_")[1])
    db.add_to_cart(PROJECT_ID, cb.message.chat.id, product_id)
    # –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞: –ø–µ—Ä–µ–π—Ç–∏ –≤ –∫–æ—Ä–∑–∏–Ω—É –∏–ª–∏ –æ–±—Ä–∞—Ç–Ω–æ –≤ –∫–∞—Ç–∞–ª–æ–≥
    kb = InlineKeyboardBuilder()
    kb.button(text="üõí –ö–æ—Ä–∑–∏–Ω–∞", callback_data="view_cart")
    kb.button(text="‚Üê –ö–∞—Ç–∞–ª–æ–≥",  callback_data="back")
    kb.adjust(1)
    # –ö–æ—Ä–æ—Ç–∫–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ (–≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ)
    await cb.answer("‚úÖ –¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω")
    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏ –¥–µ–π—Å—Ç–≤–∏–π
    await bot.send_message(cb.message.chat.id, "–ß—Ç–æ –¥–∞–ª—å—à–µ?", reply_markup=kb.as_markup())

@dp.callback_query(lambda c: c.data == "view_cart")
async def view_cart(cb: types.CallbackQuery):
    """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–æ—Ä–∑–∏–Ω—ã."""
    await show_cart(cb.message.chat.id, cb.message)

@dp.callback_query(lambda c: c.data.startswith(("dec_", "inc_", "del_")))
async def edit_cart(cb: types.CallbackQuery):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–æ–≤ –∏–ª–∏ —É–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã."""
    action, cart_id_str = cb.data.split("_")
    cart_id = int(cart_id_str)
    items = db.get_cart_items(PROJECT_ID, cb.message.chat.id)
    item = next((i for i in items if i["cart_id"] == cart_id), None)
    if not item:
        return await cb.answer("‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ", show_alert=True)

    # –£–º–µ–Ω—å—à–µ–Ω–∏–µ, —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –∏–ª–∏ —É–¥–∞–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏
    if action == "del":
        db.delete_cart_item(cart_id)
    else:
        new_qty = item["quantity"] + (1 if action == "inc" else -1)
        db.update_cart_item(cart_id, new_qty)
    await show_cart(cb.message.chat.id, cb.message)
    await cb.answer()  # —É–±–∏—Ä–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏

async def show_cart(user_id: int, msg: types.Message | None = None):
    """–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–æ—Ä–∑–∏–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∫–Ω–æ–ø–∫–∞–º–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è."""
    items = db.get_cart_items(PROJECT_ID, user_id)
    if not items:
        # –ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞
        text = "üõí –ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞."
        kb = InlineKeyboardBuilder()
        kb.button(text="‚Üê –ö–∞—Ç–∞–ª–æ–≥", callback_data="back")
        kb.adjust(1)
        if msg:
            await msg.edit_text(text, reply_markup=kb.as_markup())
        else:
            await bot.send_message(user_id, text, reply_markup=kb.as_markup())
        return

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–∑–∏—Ü–∏–π –≤ —Ç–µ–∫—Å—Ç–µ
    lines = ["<b>–í–∞—à–∏ —Ç–æ–≤–∞—Ä—ã:</b>"]
    kb = InlineKeyboardBuilder()
    for it in items:
        lines.append(f"{escape(it['name'])} ‚Äî {it['quantity']} —à—Ç.")
        cid = it["cart_id"]
        # –ö–Ω–æ–ø–∫–∏ "-" "+" "‚ùå" –¥–ª—è –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏
        kb.button(text="‚ûñ", callback_data=f"dec_{cid}")
        kb.button(text="‚ûï", callback_data=f"inc_{cid}")
        kb.button(text="‚ùå", callback_data=f"del_{cid}")
    # –ö–Ω–æ–ø–∫–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ –∏ –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –∫–∞—Ç–∞–ª–æ–≥
    kb.button(text="‚úÖ –û—Ñ–æ—Ä–º–∏—Ç—å", callback_data="checkout")
    kb.button(text="‚Üê –ö–∞—Ç–∞–ª–æ–≥",   callback_data="back")
    # –†–∞—Å–ø–æ–ª–∞–≥–∞–µ–º: –ø–æ 3 –∫–Ω–æ–ø–∫–∏ (—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ) –≤ —Ä—è–¥ –¥–ª—è –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏, –∑–∞—Ç–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ä—è–¥—ã –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∏ –≤–æ–∑–≤—Ä–∞—Ç–∞
    kb.adjust(3, 3, 1, 1)
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∫–æ—Ä–∑–∏–Ω–µ (–∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ)
    if msg:
        await msg.edit_text("\n".join(lines), reply_markup=kb.as_markup())
    else:
        await bot.send_message(user_id, "\n".join(lines), reply_markup=kb.as_markup())

# ‚îÄ‚îÄ‚îÄ –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
@dp.callback_query(lambda c: c.data == "checkout")
async def checkout(cb: types.CallbackQuery, state: FSMContext):
    """–ù–∞—á–∏–Ω–∞–µ—Ç –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞: –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏."""
    # –ó–∞–º–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∫–æ—Ä–∑–∏–Ω—ã –Ω–∞ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –≤–≤–µ—Å—Ç–∏ –∞–¥—Ä–µ—Å
    await cb.message.edit_text("–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏:")
    await state.set_state(CartState.checkout_address)
    await cb.answer()

@dp.message(StateFilter(CartState.checkout_address))
async def checkout_address(m: types.Message, state: FSMContext):
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∞–¥—Ä–µ—Å
    await state.update_data(address=m.text.strip())

    # –°—Ä–∞–∑—É –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∑–∞–∫–∞–∑
    kb = InlineKeyboardBuilder()
    kb.button(text="‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å", callback_data="confirm")
    kb.button(text="‚ùå –û—Ç–º–µ–Ω–∏—Ç—å",    callback_data="cancel")
    kb.adjust(2)

    await m.answer("<b>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –∑–∞–∫–∞–∑</b>", reply_markup=kb.as_markup())
    await state.set_state(CartState.checkout_confirm)



@dp.callback_query(lambda c: c.data == "confirm", StateFilter(CartState.checkout_confirm))
async def confirm_order(cb: types.CallbackQuery, state: FSMContext):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º."""
    data = await state.get_data()
    user_id = cb.from_user.id
    address = data.get("address", "")
    media_file = data.get("media", "")  # –∏–º—è —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ (–º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç–æ–π)

    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–æ—Ä–∑–∏–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∂–¥—É—é –ø–æ–∑–∏—Ü–∏—é –∫–∞–∫ –∑–∞–∫–∞–∑
    items = db.get_cart_items(PROJECT_ID, user_id)
    for it in items:
        order = {
            "project_id": PROJECT_ID,
            "user_id":    user_id,
            "product":    it["product_id"],
            "quantity":   it["quantity"],
            "address":    address,
            "media_path": media_file
        }
        db.save_order(order)
    db.clear_cart(PROJECT_ID, user_id)  # –æ—á–∏—â–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

    # –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–± —É—Å–ø–µ—à–Ω–æ–º –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏
    await cb.message.edit_text("‚úÖ –ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω!")
    # –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è FSM
    await state.clear()

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –∞–¥–º–∏–Ω-–≥—Ä—É–ø–ø—É –æ –Ω–æ–≤–æ–º –∑–∞–∫–∞–∑–µ
    try:
        user = cb.from_user
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∑–∞–∫–∞–∑–µ
        order_lines = [f"<b>–ù–æ–≤—ã–π –∑–∞–∫–∞–∑ –æ—Ç</b> <a href=\"tg://user?id={user.id}\">{escape(user.first_name)}</a>:"]
        for it in items:
            order_lines.append(f"{escape(it['name'])} ‚Äî {it['quantity']} —à—Ç.")
        order_lines.append(f"<b>–ê–¥—Ä–µ—Å:</b> {escape(address)}")
        if media_file:
            order_lines.append("(–ö –∑–∞–∫–∞–∑—É –ø—Ä–∏–ª–æ–∂–µ–Ω —Ñ–∞–π–ª –Ω–∏–∂–µ)")
        admin_message = "\n".join(order_lines)
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –¥–µ—Ç–∞–ª—è–º–∏ –∑–∞–∫–∞–∑–∞
        await bot.send_message(ADMIN_CHAT, admin_message)
        # –ï—Å–ª–∏ –µ—Å—Ç—å –≤–ª–æ–∂–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –µ–≥–æ –≤ –≥—Ä—É–ø–ø—É
        if media_file:
            file_path = MEDIA_ROOT / media_file
            ext = file_path.suffix.lower()
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –º–µ–¥–∏–∞ –∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –º–µ—Ç–æ–¥ –æ—Ç–ø—Ä–∞–≤–∫–∏
            if ext in {".jpg", ".jpeg", ".png", ".gif"}:
                if ext == ".gif":
                    await bot.send_animation(ADMIN_CHAT, FSInputFile(file_path))
                else:
                    await bot.send_photo(ADMIN_CHAT, FSInputFile(file_path))
            elif ext == ".mp4":
                await bot.send_video(ADMIN_CHAT, FSInputFile(file_path))
            elif ext == ".mp3":
                await bot.send_audio(ADMIN_CHAT, FSInputFile(file_path))
            else:
                await bot.send_document(ADMIN_CHAT, FSInputFile(file_path))
    except Exception as err:
        # –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–µ—Å–ª–∏ –±–æ—Ç –Ω–µ –∏–º–µ–µ—Ç –ø—Ä–∞–≤ –ø–∏—Å–∞—Ç—å –≤ –≥—Ä—É–ø–ø—É –∏ —Ç.–ø.)
        print(f"[WARN] –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –∞–¥–º–∏–Ω-–≥—Ä—É–ø–ø—É: {err}")

@dp.callback_query(lambda c: c.data == "cancel", StateFilter(CartState.checkout_confirm))
async def cancel_order(cb: types.CallbackQuery, state: FSMContext):
    """–û—Ç–º–µ–Ω–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞."""
    await cb.message.edit_text("‚ùå –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.")
    await state.clear()

# ‚îÄ‚îÄ‚îÄ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å: –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
@dp.message(Command("addproduct"))
async def adm_add_product(message: types.Message, state: FSMContext):
    """–ù–∞—á–∏–Ω–∞–µ—Ç –¥–∏–∞–ª–æ–≥ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ (—Ç–æ–ª—å–∫–æ –≤ ADMIN_CHAT)."""
    if message.chat.id != ADMIN_CHAT:
        return  # –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—É, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ –∏–∑ –∞–¥–º–∏–Ω—Å–∫–æ–π –≥—Ä—É–ø–ø—ã
    await message.answer("–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞:")
    await state.set_state(ProductAdminState.name)

@dp.message(StateFilter(ProductAdminState.name))
async def adm_enter_name(message: types.Message, state: FSMContext):
    await state.update_data(name=message.text.strip())
    await message.answer("–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ:")
    await state.set_state(ProductAdminState.short_desc)

@dp.message(StateFilter(ProductAdminState.short_desc))
async def adm_enter_short_desc(message: types.Message, state: FSMContext):
    await state.update_data(short_desc=message.text.strip())
    await message.answer("–ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ:")
    await state.set_state(ProductAdminState.full_desc)

@dp.message(StateFilter(ProductAdminState.full_desc))
async def adm_enter_full_desc(message: types.Message, state: FSMContext):
    await state.update_data(full_desc=message.text.strip())
    await message.answer("–ü—Ä–∏—à–ª–∏—Ç–µ –∫–∞—Ä—Ç–∏–Ω–∫—É –¥–ª—è —Ç–æ–≤–∞—Ä–∞ (–∏–ª–∏ –Ω–∞–ø–∏—à–∏—Ç–µ ¬´–Ω–µ—Ç¬ª):")
    await state.set_state(ProductAdminState.waiting_img)

@dp.message(Command("ban"))
async def cmd_ban(message: types.Message):
    if message.chat.id != ADMIN_CHAT:
        return
    # –æ–∂–∏–¥–∞–µ–º: /ban <user_id>
    parts = message.text.split()
    if len(parts) != 2 or not parts[1].isdigit():
        return await message.reply("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /ban <user_id>")
    target_id = int(parts[1])
    db.ban_user(PROJECT_ID, target_id)
    await message.reply(f"‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {target_id} –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.")

@dp.message(Command("unban"))
async def cmd_unban(message: types.Message):
    if message.chat.id != ADMIN_CHAT:
        return
    parts = message.text.split()
    if len(parts) != 2 or not parts[1].isdigit():
        return await message.reply("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /unban <user_id>")
    target_id = int(parts[1])
    db.unban_user(PROJECT_ID, target_id)
    await message.reply(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {target_id} —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.")

@dp.message(StateFilter(ProductAdminState.waiting_img))
async def adm_enter_image(message: types.Message, state: FSMContext):
    data = await state.get_data()
    media_filename = ""
    if message.text and message.text.lower() == "–Ω–µ—Ç":
        media_filename = ""
    else:
        file = None
        orig_name = ""
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –ø–æ–ª—É—á–µ–Ω–Ω–æ–≥–æ –º–µ–¥–∏–∞-—Ñ–∞–π–ª–∞
        if message.photo:
            file = message.photo[-1]
            orig_name = "product.jpg"
        elif message.video:
            file = message.video
            orig_name = message.video.file_name or "product.mp4"
        elif message.document:
            file = message.document
            orig_name = message.document.file_name or f"file{Path(file.file_id).suffix or ''}"
        elif message.audio:
            file = message.audio
            orig_name = message.audio.file_name or "product.mp3"
        if file:
            file_bytes = await bot.download(file)
            try:
                saved_path = save_media_file(PROJECT_ID, file_bytes.getvalue(), orig_name)
                media_filename = saved_path.name
            except ValueError as e:
                await message.answer(f"‚ö†Ô∏è –§–∞–π–ª –Ω–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω: {e}\n–¢–æ–≤–∞—Ä –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –±–µ–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.")
                media_filename = ""
        else:
            media_filename = ""
    # –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–≤–∞—Ä –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
    db.add_product(PROJECT_ID, data["name"], data["short_desc"], data["full_desc"], media_filename)
    await message.answer("‚úÖ –¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω.")
    await state.clear()

# ‚îÄ‚îÄ‚îÄ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å: —É–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
@dp.message(Command("delproduct"))
async def adm_delete_product_start(message: types.Message, state: FSMContext):
    """–ù–∞—á–∏–Ω–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞: –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤ —Å –Ω–æ–º–µ—Ä–∞–º–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è."""
    if message.chat.id != ADMIN_CHAT:
        return
    await state.update_data(del_page=1)
    await send_delete_page(message.chat.id, state)

@dp.callback_query(lambda c: c.data in {"dprev", "dnext"}, StateFilter(DeleteProductState.selecting_page))
async def adm_delete_nav(cb: types.CallbackQuery, state: FSMContext):
    """–õ–∏—Å—Ç–∞–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∫–∞—Ç–∞–ª–æ–≥–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞ (–≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏)."""
    data = await state.get_data()
    page = data.get("del_page", 1)
    products = db.get_products_list(PROJECT_ID)
    if cb.data == "dprev" and page > 1:
        page -= 1
    elif cb.data == "dnext" and page * 9 < len(products):
        page += 1
    await state.update_data(del_page=page)
    await send_delete_page(cb.message.chat.id, state)
    await cb.answer()

async def send_delete_page(chat_id: int, state: FSMContext):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫–∞—Ç–∞–ª–æ–≥–∞ —Ç–æ–≤–∞—Ä–æ–≤ —Å –ø—Ä–æ–Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –ø–æ–∑–∏—Ü–∏—è–º–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è."""
    page = (await state.get_data()).get("del_page", 1)
    products = db.get_products_list(PROJECT_ID)
    slice_ = products[(page - 1) * 9 : page * 9]

    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–ª–ª–∞–∂ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã —É–¥–∞–ª—è–µ–º—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤
    collage_path = Path(tempfile.gettempdir()) / f"delete_{page}.jpg"
    generate_collage([str(MEDIA_ROOT / p["media"]) for p in slice_ if p["media"]], collage_path)

    kb = InlineKeyboardBuilder()
    for idx, _ in enumerate(slice_, start=1):
        kb.button(text=str(idx), callback_data=f"dsel_{idx}")
    if page > 1:
        kb.button(text="‚óÄÔ∏è", callback_data="dprev")
    if page * 9 < len(products):
        kb.button(text="‚ñ∂Ô∏è", callback_data="dnext")
    kb.adjust(3)
    await bot.send_photo(chat_id, FSInputFile(collage_path),
                         caption="–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:", reply_markup=kb.as_markup())
    await state.set_state(DeleteProductState.selecting_page)

@dp.callback_query(lambda c: c.data.startswith("dsel_"), StateFilter(DeleteProductState.selecting_page))
async def adm_select_delete(cb: types.CallbackQuery, state: FSMContext):
    """–§–∏–∫—Å–∏—Ä—É–µ—Ç –≤—ã–±–æ—Ä —Ç–æ–≤–∞—Ä–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∏ –ø—Ä–æ—Å–∏—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ/–æ—Ç–º–µ–Ω—É."""
    idx = int(cb.data.split("_")[1]) - 1
    page = (await state.get_data())["del_page"]
    products = db.get_products_list(PROJECT_ID)
    global_idx = (page - 1) * 9 + idx
    if global_idx >= len(products):
        return await cb.answer("–ù–µ–≤–µ—Ä–Ω–æ", show_alert=True)
    product_id = products[global_idx]["id"]
    await state.update_data(del_id=product_id)
    # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è
    kb = InlineKeyboardBuilder()
    kb.button(text="‚úÖ –£–¥–∞–ª–∏—Ç—å", callback_data="dconfirm")
    kb.button(text="‚ùå –û—Ç–º–µ–Ω–∞",  callback_data="dcancel")
    kb.adjust(2)
    await cb.message.edit_caption(f"–í—ã–±—Ä–∞–Ω —Ç–æ–≤–∞—Ä #{product_id}. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —É–¥–∞–ª–µ–Ω–∏–µ.", reply_markup=kb.as_markup())
    await state.set_state(DeleteProductState.confirming_delete)
    await cb.answer()

@dp.callback_query(lambda c: c.data == "dconfirm", StateFilter(DeleteProductState.confirming_delete))
async def adm_delete_confirm(cb: types.CallbackQuery, state: FSMContext):
    """–£–¥–∞–ª—è–µ—Ç —Ç–æ–≤–∞—Ä –∏–∑ –±–∞–∑—ã (–ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∞–¥–º–∏–Ω–æ–º)."""
    data = await state.get_data()
    product_id = data.get("del_id")
    # –£–¥–∞–ª—è–µ–º —Ç–æ–≤–∞—Ä –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    db.delete_product(PROJECT_ID, product_id)
    await cb.message.edit_caption(f"‚úÖ –¢–æ–≤–∞—Ä #{product_id} —É–¥–∞–ª—ë–Ω.", reply_markup=None)
    await state.clear()

@dp.callback_query(lambda c: c.data == "dcancel", StateFilter(DeleteProductState.confirming_delete))
async def adm_delete_cancel(cb: types.CallbackQuery, state: FSMContext):
    """–û—Ç–º–µ–Ω–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞."""
    await cb.message.edit_caption("‚ùå –£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.", reply_markup=None)
    await state.clear()
# ‚îÄ‚îÄ‚îÄ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫, —á—Ç–æ–±—ã –ø–æ—Ç–æ–º –º–æ–∂–Ω–æ –±—ã–ª–æ –¥–æ–±–∞–≤–ª—è—Ç—å –∑–∞–¥–∞—á–∏ –≤ Admin-–ø–∞–Ω–µ–ª–∏
from apscheduler.schedulers.asyncio import AsyncIOScheduler
scheduler = AsyncIOScheduler()
@dp.startup()
async def on_startup():
    scheduler.start()

# ‚îÄ‚îÄ‚îÄ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async def setup_bot_commands(bot: Bot):
    # 1) –û–±—â–∏–µ –∫–æ–º–∞–Ω–¥—ã (–≤–∏–¥–Ω—ã –≤–µ–∑–¥–µ, –µ—Å–ª–∏ –Ω–µ—Ç –±–æ–ª–µ–µ —É–∑–∫–æ–≥–æ scope)
    default_cmds = [
        BotCommand(command="start",      description="–ü–æ–∫–∞–∑–∞—Ç—å –∫–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤"),
    ]
    await bot.set_my_commands(
        default_cmds,
        scope=BotCommandScopeDefault(),
        language_code="ru"
    )

    # 2) –õ–∏—á–Ω—ã–µ —á–∞—Ç—ã ‚Äî –¥—É–±–ª–∏—Ä—É–µ–º
    await bot.set_my_commands(
        default_cmds,
        scope=BotCommandScopeAllPrivateChats(),
        language_code="ru"
    )

    # 3) –í—Å–µ –≥—Ä—É–ø–ø–æ–≤—ã–µ —á–∞—Ç—ã ‚Äî —Ç–æ–∂–µ –¥—É–±–ª–∏—Ä—É–µ–º
    await bot.set_my_commands(
        default_cmds,
        scope=BotCommandScopeAllGroupChats(),
        language_code="ru"
    )

    # 4) –ê–¥–º–∏–Ω-–≥—Ä—É–ø–ø–∞ ‚Äî –æ–±—ä–µ–¥–∏–Ω—è–µ–º –æ–±—ã—á–Ω—ã–µ –∏ –∞–¥–º–∏–Ω—Å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã
    admin_cmds = [
        BotCommand(command="addproduct", description="–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä (–∞–¥–º–∏–Ω)"),
        BotCommand(command="delproduct", description="–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä (–∞–¥–º–∏–Ω)"),
        BotCommand(command="ban",        description="–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"),
        BotCommand(command="unban",      description="–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"),
    ]
    await bot.set_my_commands(
        default_cmds + admin_cmds,
        scope=BotCommandScopeChat(chat_id=ADMIN_CHAT),
        language_code="ru"
    )

