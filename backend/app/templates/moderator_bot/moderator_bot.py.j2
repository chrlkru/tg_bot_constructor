#!/usr/bin/env python3
import os
from dotenv import load_dotenv

from aiogram import Bot, Dispatcher, executor, types
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.contrib.fsm_storage.memory import MemoryStorage

from utils.moderation import (
    check_message,
    add_strike,
    log_violation,
    format_report,
    toggle_setting,
    whitelist_add,
    whitelist_del,
    list_whitelist,
    get_settings
)

# â€” Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ñ‚Ğ¾ĞºĞµĞ½Ğ° Ğ¸ Ğ±Ğ¾Ñ‚Ğ° â€”
load_dotenv()
BOT_TOKEN = os.getenv("TOKEN")
bot = Bot(token=BOT_TOKEN, parse_mode="HTML")
dp  = Dispatcher(bot, storage=MemoryStorage())

# â€” ĞšĞ¾Ğ½ÑÑ‚Ğ°Ğ½Ñ‚Ñ‹ â€”
PROJECT_ID = {{ project.id }}
ADMIN_CHAT = {{ project.content.admin_chat_id }}

# â”€â”€ ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@dp.message_handler(content_types=types.ContentTypes.ANY)
async def auto_filter(msg: types.Message):
    ct  = msg.content_type
    txt = msg.text or msg.caption or ""
    violations = check_message(PROJECT_ID, msg.chat.id, msg.from_user.id, txt, ct)
    if not violations:
        return
    await msg.delete()
    strikes = add_strike(PROJECT_ID, msg.chat.id, msg.from_user.id)
    log_violation(
        PROJECT_ID, msg.chat.id, msg.from_user.id,
        msg.message_id, ",".join(violations), txt
    )
    if "spam" in violations:
        await bot.kick_chat_member(msg.chat.id, msg.from_user.id)
        await bot.send_message(
            msg.chat.id,
            f"ğŸš« {msg.from_user.get_mention(as_html=True)} Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ Ğ·Ğ° Ñ„Ğ»ÑƒĞ´."
        )
    else:
        if strikes >= 3:
            await bot.kick_chat_member(msg.chat.id, msg.from_user.id)
            await bot.send_message(
                msg.chat.id,
                f"ğŸš« {msg.from_user.get_mention(as_html=True)} Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ (3 Ğ¿Ñ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ñ)."
            )
        else:
            await bot.send_message(
                msg.chat.id,
                f"âš ï¸ {msg.from_user.get_mention(as_html=True)}, Ğ¿Ñ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ğµ "
                f"({strikes}/3). ĞĞ°Ñ€ÑƒÑˆĞµĞ½Ğ¸Ñ: {', '.join(violations)}."
            )

# â”€â”€ Ğ–Ğ°Ğ»Ğ¾Ğ±Ğ° Ñ‡ĞµÑ€ĞµĞ· /report â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@dp.message_handler(commands=['report'])
async def report_handler(msg: types.Message):
    if not msg.reply_to_message:
        return await msg.answer(
            "Ğ§Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒÑÑ, Ğ¾Ñ‚Ğ²ĞµÑ‚ÑŒÑ‚Ğµ Ğ½Ğ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¸ Ğ²Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ /report [Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°]"
        )
    reporter = msg.from_user.username or msg.from_user.id
    orig     = msg.reply_to_message
    reason   = msg.get_args()
    await bot.forward_message(ADMIN_CHAT, orig.chat.id, orig.message_id)
    text = format_report(reporter, orig.chat.id, orig.message_id, reason)
    await bot.send_message(ADMIN_CHAT, text)
    await msg.answer("âœ… Ğ–Ğ°Ğ»Ğ¾Ğ±Ğ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ° Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ°Ğ¼.")

# â”€â”€ ĞĞ´Ğ¼Ğ¸Ğ½-ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ Ğ´Ğ»Ñ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞº â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@dp.message_handler(commands=['set_media'])
async def cmd_set_media(msg: types.Message):
    arg = msg.get_args().lower()
    val = 1 if arg in ("on","yes","1","true") else 0
    toggle_setting(PROJECT_ID, 'allow_media', val)
    await msg.answer(f"media {'ON' if val else 'OFF'}")

@dp.message_handler(commands=['set_stickers'])
async def cmd_set_stickers(msg: types.Message):
    arg = msg.get_args().lower()
    val = 1 if arg in ("on","yes","1","true") else 0
    toggle_setting(PROJECT_ID, 'allow_stickers', val)
    await msg.answer(f"stickers {'ON' if val else 'OFF'}")

@dp.message_handler(commands=['set_censor'])
async def cmd_set_censor(msg: types.Message):
    arg = msg.get_args().lower()
    val = 1 if arg in ("on","yes","1","true") else 0
    toggle_setting(PROJECT_ID, 'censor_enabled', val)
    await msg.answer(f"censor {'ON' if val else 'OFF'}")

@dp.message_handler(commands=['set_flood'])
async def cmd_set_flood(msg: types.Message):
    parts = msg.get_args().split()
    if len(parts) != 2 or not all(p.isdigit() for p in parts):
        return await msg.answer("Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ: /set_flood <max_reps> <window_minutes>")
    maxr, winm = map(int, parts)
    toggle_setting(PROJECT_ID, 'flood_max', maxr)
    toggle_setting(PROJECT_ID, 'flood_window_s', winm * 60)
    await msg.answer(f"flood_max={maxr}, window={winm}m")

@dp.message_handler(commands=['whitelist_add'])
async def cmd_whitelist_add(msg: types.Message):
    dom = msg.get_args().strip().lower()
    whitelist_add(PROJECT_ID, dom)
    await msg.answer(f"Ğ”Ğ¾Ğ¼ĞµĞ½ {dom} Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½ Ğ² whitelist")

@dp.message_handler(commands=['whitelist_del'])
async def cmd_whitelist_del(msg: types.Message):
    dom = msg.get_args().strip().lower()
    whitelist_del(PROJECT_ID, dom)
    await msg.answer(f"Ğ”Ğ¾Ğ¼ĞµĞ½ {dom} ÑƒĞ´Ğ°Ğ»Ñ‘Ğ½ Ğ¸Ğ· whitelist")

@dp.message_handler(commands=['list_whitelist'])
async def cmd_list_whitelist(msg: types.Message):
    items = list_whitelist(PROJECT_ID)
    text = "Whitelist:\n" + ("\n".join(items) if items else "â€” Ğ¿ÑƒÑÑ‚Ğ¾ â€”")
    await msg.answer(text)

if __name__ == "__main__":
    executor.start_polling(dp, skip_updates=True)
